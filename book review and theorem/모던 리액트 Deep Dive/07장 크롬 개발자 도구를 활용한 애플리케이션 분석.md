# 07장 크롬 개발자 도구를 활용한 애플리케이션 분석

## 7.5 메모리 탭

> 메모리 탭에서는 현재 웹페이지가 차지하고 있는 메모리 관련 정보를 확인할 수 있다.
>
> 이 탭은 크롬 개발자 도구에서 제공하는 도구 중 가장 난이도가 높고 까다롭다. 그러나 애플리케이션에서 발생하는 메모리 누수, 속도 저하, 혹은 웹페이지 프리징 현상을 확인하 ㄹ수 있는 유용한 도구다.

- 메모리 탭을 열면 리액트 개발 도구의 프로파일과 비슷하게 프로파일링 작업을 거쳐야 원하는 정보를 볼 수 있음을 확인할 수 있다.
- 프로파일은 세가지 유형이 있다
  - 힙 스냅샷: 스냅샷이라는 이름에 걸맞게 `현재 메모리 상황`을 사진 찍듯이 촬영할 수 있다. 현재 시점의 메모리 상황을 알고 싶다면 힙 스냅샷을 활용하면 된다
  - 타임라인의 할당 계측: 현재 시점의 메모리 상황이 아닌, `시간의 흐름에 따라 메모리의 변화`를 살펴보고 싶다면 타임라인의 할당 계측을 사용하면 된다. 주로 로딩이 되는 과정의 메모리 변화 또는 페이지에서 어떠한 상호작용을 했을 때 메모리의 변화 과정을 알고 싶을 때 사용한다
  - 할당 샘플링: 메모리 공간을 차지하고 있는 자바스크립트 함수를 볼 수 있다

1. 자바스크립트 인스턴스 VM 선택
   - 현재 실행중인 자바스크립트 VM 인스턴스를 확인할 수 있다
   - 여기서 먼저 개발자가 디버깅하고 싶은 자바스크립트 VM 환경을 선택하면 된다.
   - 그리고 환경별 힙 크기를 볼 수 있는데, 실제 해당 페이지가 자바스크립트 힙을 얼마나 점유하고 있는지 나타낸다
   - 이 크기만큼 사용자의 브라우저에 부담을 주기에 늘어나지 않늕지 눈여겨 봐야한다
2. 힙 스냅샷

   - 힙 스냅샷은 현재 페이지의 메모리 상태를 확인해 볼 수 있는 메모리 프로파일 도구다.
   - `촬영하는 시점`을 기준으로 마치 사진으로 촬영하듯 메모리 현황을 보여준다.
   - 리액트 기반 애플리케이션이 기본적으로 차지하는 내용 + window 객체 등 브라우저가 차지하는 내용 + 기타 패키지 내용이 포함
   - 동작전후로 스냅샷을 찍으면 메모리 크기가 달라지는 것을 볼 수 있을 것이다
   - 얕은 크기?

     - 얕은 크기: 객체 자체가 보유하는 메모리 바이트의 크기
     - 유지된 크기: 해당 객체 자체뿐만 아니라 다른 부모가 존재하지 않는 모든 자식 객체들의 크기까지 더한 값
     - ```javascript
       var counter = 0;
       var instances = [];

       function Y() {
         this.j = 5;
       } // 얕은 크기 : 48%, 유지된 크기 : 48%

       function X() {
         this.i = counter++;
         this.y = new Y();
       }
       // 얕은 크기 : 52%, 유지된 크기 : 100%
       // 48% 차이 = 객체 자체가 참조를 보유하고 있는 Y 객체의 크기

       export default function App() {
         function handleClick() {
           instances.push(new X());
         }
       }

       return <button onClick={handleClick}>+</button>;
       ```

     - 메모리 누수를 찾을 때는 얕은 크기는 작지만 유지도니 크기가 큰 객체를 찾아야 한다
       - 다수의 다른 객체를 참조하고 있다는 뜻
       - 이런 객체가 오랜 시간 메모리에 남아 있다면 많은 메모리를 점유하게 된다.

   - 스냅샷 촬영을 제대로 활용하려면 두개 이상을 촬영하여 비교해야 한다.
     - 대표적인 예로 useMemo, useCallback과 같은 의존성이 있는 값들이 정말로 렌더링 사이에 그대로 유지되는지 육안으로 직접 확인할 수 있다.
     - 익명 화살표 함수는 사용할 때는 간단하지만 디버깅할 때는 그다지 도움이 되지 않는다. 그러니 setter함수 내부에서 기명함수로 바꾼다면 힙 스냅샷에서 바로 확인할 수 있다.

3. 타임라인 할당 계측
   - 시간의 흐름에 따라 메모리 변화를 확인할 수 있는 기능
   - 기간을 조절해서도 확인이 가능하다
   - 전역변수로 저장을 이용하면 콘솔에서 해당 변수를 확인할 수 있다
4. 할당 샘플링
   - 할당 샘플링은 시간의 흐름에 따라 발생하는 메모리 점유를 확인할 수 있다.
   - 타임라인 할당 계측과 비슷하지만 자바스크립트 실행 스택별로 분석할 수 있고, 이 분석을 함수 단위로 한다는 차이점이 있다.
   - 할당 샘플링에서 용량순으로 정렬도 가능하며 소스 패널에 표시를 선택해 해당 함수가 어느 파일에서 어떻게 정의됐는지도 확인할 수 있다.
