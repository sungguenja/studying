# SPA 뒤로가기 스크롤 및 상태복원 구현하기

스크롤 복원은 왜 필요한가?

- 기획 상 필요없는 경우도 있음
- 페이지네이션 방식이라 문서스크롤 높이가 짧은 경우
- 회원가입이라면 약관정도 보여주는 것이라 뒤로가기가 플로우상 중요치 않을 수도 있음
- 기획자에게 물어보는 것이 정확
- 근데 보통 그냥 다 필요하다함 ㅎㅎㅎㅎ
- 코드가 추가된다 == 무조건 관리포인트, 유지보수 대상
- 기획 니즈, 서비스 환경 등 우선순위를 두고 복원 로직들을 구현할지 안할지 검토 필요

## 관련 브라우저 API살펴보기

`history.scrollRestoration = 'manual';`

- 원래 뒤로가기 앞으로가기 시 브라우저 나름대로 스크롤복원을 함
- 다만 복원 시점 제어 불가로 인해 렌더링 전에 복원되면 스크롤이 산으로 가는 상황 발생
- 이 값을 'manual'로 설정하면 브라우저가 스크롤을 건드리지 않게 할 수 있다
- 하여 스크롤 복원의 정확도를 높이기 위해 'manual'로 설정하고 시작

`performance.navigation.type === 2`

- 현재 보고 있는 문서로 어떻게 왔는지 정보를 제공
- 0,1,2,255가 있다
- 앱 초기화 시점에 값이 2이면 복원 필요

`Back Forward Cache`

- 브라우저 탐색 시 자바스크립트 힙 포함 페이지의 전체 스냅샷을 저장하는 메모리 캐시
- 뒤로가기. 앞으로가기 시점에 그냥 복원되고 가만히 있기 때문에 이후 뭔가 하고 싶다면 pageshow이벤트 핸들러 구현필요. (결제완료하고 뒤로가기 했더니 아직도 결제대기로 보인다!)
- 이것이 없으면 뒤로가기 시 페이지가 새로고침되고 스크롤이 맨 위로 올라간 채로 보이게 된다.

그래서 이것때문에 분기가 생긴다

bfcache 지원브라우저 미지원브라우저 분기 VS bfcache 비활성화 후 같은 코드 사용하기.

해당 컬럼은 후자를 택했다

- HTML문서 응답 헤더에 "Cache-Control: no-cache, no-store, must-revalidate"를 포함하면 비활성화 가능
- 비활성화 되면 `performance.navigation.type === 2` 이것이 가능해진다

## 복원 로직

1. 앱 내부에서만 라우팅되는 경우
   - Angular는 RouterReuseStrategy라는 인터페이스를 통해 간단히 화면에 렌더링된 컴포넌트의 전체 상태를 캐싱하고 복원할 수 있음
   - 이 API가 있다는 것을 늦게 알아서 해당 컬럼은 사용하지 않고 직접 구현했다함. 그리고 직접 구현하는 것이 의존성을 낮추고 범용성을 올릴 수 있는 방안이긴 하다
   - history이벤트가 일어날 때 이벤트와 ngrx(redux)의 single store복제본을 페어로 캐시해두었다가 뒤로가기 시 찾아서 별도의 action으로 덮어쓰는 방식
   - 그럼 복원 이후 컴포넌트 라이프사이클에서 초기 dispatch는 어떻게 막을까?
     - 훅에서 별도로 구현을 해야함
   - history변경 이벤트 (NavigationStart) 에 id가 있어서 그때마다 id와 store사본을 객체에 차곡차곡 저장하고
   - 일반 라우팅 일땐 쿼리 객체만 제공. 컴포넌트는 쿼리로 API호출
   - 만약 이벤트 타입이 popstate일 경우 뒤로가기 id에 해당하는 상태를 찾아서 컴포넌트의 콜백 파라미터에 restore필드로 추가
   - 이제 컴포넌트가 결정하면 됨. restore가 있다면 복원하면 되고 없다면 쿼리 받아서 api호출하던가
2. 앱 외부로 나갔다 돌아올 수 있는 경우
   - 의외로 이런 경우 자주 일어난다. 대표적으로 이벤트를 하면 보통 그 이벤트에 대해 그냥 redirect를 이용하는데 이때 돌아오면 앱 탐색중 외부로 나갔다가 돌아오는 상황이 되버린다
   - 인앱 로직에 추가하는 형태로 구현
   - meta-reducer에서 액션 dispatch때 마다 전체 상태를 세션 스토리지에 저장하고
   - 앱 초기화 시점에 `performance.navigation.type === 2`인 경우 세션 스토리지에 저장한 상태를 복원
   - 외부 페이지들은 이벤트 페이지와 react에서 angular로 전환 과정 중 아직 옮기지 못한 페이지들이 있음
   - 세션 스토리지에 동일 키로 덮어쓰기 때문에 뒤로가기 진입시 1회에 대해서만 복원가능 (기획협의 된 부분)
   - 스토리지 용량 제한 에러 수집은 아직까진 없다함
3. 스크롤 복원
   - `@angular/router`의 라우팅 이벤트 중에는 "Scroll" 이라는 이벤트가 있다
   - 뒤로가기 앞으로가기로 탐색시 이벤트가 발생 => 인자에 스크롤 위치가 있따. 그 시점에 그냥 문서 스크롤을 설정하면 된다.
   - 뒤로가기의 경우
     - 스크롤 될 때마다 세션스토리지에 담은 스크롤 위치를
     - 초기화 시점에 1회 `performance.navigation.type === 2`인 경우 복원시키면 된다
   - 렌더링이 끝나고 **원래대로 늘어난 시점**에 스크롤 복원해야함

## 추가 질문: 렌더링이 끝난 시점을 어찌 아는가?

1. 세션 스토리지에 담긴 스크롤 위치 + 화면 높이만큼 문서 높이를 강제 지정
2. 스크롤을 복원한 후 강제 지정한 높이를 뺄 타이밍을 알아야 함
3. Angular 내장 ngZone.onStable 메서드는 인자로 콜백을 받는다
   1. 꽤 단순하게 생각해보자 대부분의 비동기 호출은 api콜이다
   2. api콜이 일어나면 렌더링이 일어난 다는 소리이다
   3. 이런 생각으로 api콜의 호출되는 정도를 파악하는 것도 방법이다.