# 실수 없이 안전하게 쿠버네티스 운영하기

[영상 링크](https://www.youtube.com/watch?v=gF1wfTCDyI8)

- 쿠버네티스의 컨테이너
  - 이점 - 격리를 통해 보안성을 올림
  - 단점 - 가시성을 떨어뜨려 보안성과 휴먼에러를 일으킬 수가 있다
    - 간단한 변경으로 에러 가능
    - 자신감이 있어도 전파가 불가능

단점에 대한 대비책으로 두가지를 이야기 하겠다

> ArgoCD를 이용한 GitOps패턴
>
> Open Policy Agent(OPA)를 통한 안전 정책 적용

토스는 아래와 같은 쿠버네티스가 운영되고 있다

- Testbed 클러스터
  - 아무 트래픽이 없다
- Dev 클러스터
  - 개발 테스트 목적의 트래픽이 들어온다
- Live 클러스터
  - 부분과 전체로 나뉘어있다

격리가 되어있어서 개발에 이점이 있지만 각 클러스터마다 사용하는 모듈들의 버전이 달라서 사이드 이팩트가 일어날 가능성도 생기기 시작했다

가시성과 명확한 형상관리를 위해 GitOps를 이용하기로 했다.

## GitOps?

git을 어플리케이션의 single ource of truth로 여긴다. 즉, 시스템의 생성/삭제/수정등 배포 관점의 모든 작업을 git으로 관리하는 것이다.

이것을 이용하기 위해 ArgoCD를 이용할 수가 있다. ArgoCD는 배포 상태와 깃 상태를 일치시키는 오픈소스이다. 

ArgoCD를 아래와 같이 이용하는 편이다

1. Api서버와 타겟 Git소스를 클론 받아 매니페스트를 관리하는 레포지터리 서버
2. 생성된 매니페스트와 실제 리소스를 비교/싱크하는 컨트롤러 서버 존재

ArgoCD를 이용해 변경사항을 Git의 탬플릿상과 클러스터 상에서 더블 체크가 가능하다.

## App-of-Apps 구조

모든 클러스터를 부트스트래핑하는 구조. 각 클러스터만의 yaml파일을 이용해 각 클러스터의 상황을 공유할 수가 있고 모든 인프라 리소스를 설정할 수가 있다. 거기에 글로벌 형상까지 추적을 할 수가 있다.

## K8S 시크릿 관리

Vault를 이용해 쿠버네틱스 시크릿을 관리할 수가 있다. 하지만 Vault의 단점으로 배포시에 체크해야할 것들이 많다는 단점도 생겼다.

## OPA로 휴먼 에러 관리하기

특정 정책을 설정하고 디시젼 메이킹을 수행하는 방식. 다양한 방식과 기능이 많지만 해당 영상에서는 에러 관리만 이야기 하도록 하겠다.

쿠버네티스 api에 생성 요청을 할시 일반적인 경우는 사람의 권한을 체크하고 해당행위를 할 것이다. 하지만 controller가 존재한다면 controller가 한번더 확인을 하게 되고 OPA가 있다면 해당 방식을 쉽게 구현할 수가 있다.

즉, 특정 정책을 OPA로 정의해두면 OPA가 관리를 해준다는 것이다