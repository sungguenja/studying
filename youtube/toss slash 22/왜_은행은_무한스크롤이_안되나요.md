# 왜 은행은 무한스크롤이 안되나요

[영상링크](https://www.youtube.com/watch?v=v9rcKpUZw4o)

> 계좌의 거래내역을 어떻게 유저에게 빠르고 안정적으로 제공하는지에 관한 내용이 전개될 예정이다

- 은행은 보통 기간으로 결제 기간을 조회해야한다.
- 하지만 일반적인 sns는 무한스크롤이 아주 잘된다!
- 왜?
  - 은행 시스템의 구조
  - 은행 앱 <=> 채널계 <=> 계정계
  - 계정계
    - 실제로 유저의 돈을 다룸
    - 원본 데이터 보유중
    - 신뢰도가 중요
  - 채널계
    - 데이터를 보여주는 용도의 서버
    - 직접적인 결제 데이터가 필요할때 계정계에게 요청을 보냄

## 토스뱅크도 은행앱과 같은 구조이다

- 그런데 무한 스크롤이 가능하다?
- 어떻게?
  - ![](/toss%20bank.PNG)
  - 뱅킹서버 아래는 카프카
  - 이것은 이상적인 상황에서는 잘 돌아간다.
- 카프카가 좋은 역할을 한다
  - 송금 실패의 케이스는 아래와 같은 순서로 흘러간다
    1. 송금 요청 1 (앱 => 송금서버)
    2. 송금 요청 2 (송금서버 => 코어뱅킹 서버)
    3. 응답 지연 (코어뱅킹 서버 => 송금 서버)
    4. 에러응답 (송금 서버 => 앱)
    5. 송금 완료 알림 (코어뱅킹 서버 => 카프카)
    6. 송금 완료 확인 (카프카 => 송금서버)
    7. 송금 이력 저장 (송금서버가 db에 저장)
  - 하지만 위 케이스도 문제가 있다
  - 타임아웃으로 유저가 실패한줄 알고 다시 송금할 경우가 있다
  - 아래와 같은 순서가 더 추가된다
    1. 유저가 실패한 줄 알고 다시 송금
    2. 송금 거절 (송금 서버 => 앱)
    3. 송금 요청 저장 (송금 서버가 db에 저장)
    4. 저장 완료 이후엔 송금 요청을 승인하는 상태로 변경
  - 하지만! 영원히 저장이 되지 않는다면?
    - 해당 문제를 피하기 위해 **_송금서버는 주기적으로 코어뱅킹 서버에 상태를 조회한다_**
    1. 송금 상태 조회 (송금 서버 => 코어뱅킹 서버)
    2. '없음'으로 응답 (코어뱅킹 서버 => 송금 서버)
    3. 송금 실패 처리 (송금 서버가 db에 저장)
    4. 송금 요청을 승인할 수 있도록 상태가 변경
  - 하지만! 또! 다른 문제가 있을 수 있다!
    - 뒤늦게 송금 요청이 도착한다면?
    - 없음으로 저장했지만 코어뱅킹 서버에 송금요청이 도달할 수도 있다
    - 서로 타임 아웃 시간을 지정하자(토스뱅크의 경우 1분)
    - 그래서 요청 시간과 도달한 시간을 비교하여 송금 요청을 거절하게 해야한다
  - 기타 다양한 사례도 살펴보자
    - 500원 입금 동기화 실패 후 100원 동기화가 성공할 경우
    - 서버는 500원을 재 동기화하려고 한다
    - 그 사이에 유저가 볼 가능성이 있다!
    - 그래서 이에 대한 대처로 송금 서버가 동기화가 될 때마다 이전에 동기화되지 않은 거래가 있는지 계속 조회한다
    - 만약 마지막 상황마저 실패할 경우 100원 동기화마저 실패처리를 한다
    - 그리고 재 동기화를 시도한다
    - 하지만 유저가 그 사이에 요청할 수도 있다. 그래서 동기화 상태일 경우에 요청이 오면 동기화를 하는 중이라고 로딩을 보여주고 동기화를 최대한 빠르게 한다
