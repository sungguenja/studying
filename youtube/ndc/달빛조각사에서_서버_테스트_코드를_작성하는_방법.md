# '달빛조각사'에서 서버 테스트 코드를 작성하는 방법

[영상링크](https://www.youtube.com/watch?v=sIif0u4LpSU)

> 1. 어떻게 뿌리 내렸는가
> 2. 어떻게 작성 했는가
> 3. 어떻게 기반 코드를 만들었는가
> 4. 어떻게 더 빠르게 했는가

## 1. 서버 테스트 뿌리 내리기

- 초반 작업 세가지
  - 구성원들의 동의
  - 테스트 환경 구축
  - 주요 로직 테스트
- 테스트 성공 상태 유지
  - 실패를 방치할수록
    - 실패 원인 찾기 비용
    - 성공하도록 고치는 비용
  - 개발 프로세스
    - 실패를 관리하는 게 목표
  - feature branch 전략을 이용
    - 작업 브랜치에서
      - 코드 포맷팅 검사
      - 정적 코드 분석
      - 코드 리뷰 후 머지
      - 머지 되면 자동 테스트 실행
- 열심히 테스트 추가하기
  - 느슨한 규칙
    - 테스트가 없어도 코드 리뷰 진행
    - 하지만 테스트를 깨면 반드시 고쳐야 한다
  - 테스트 짜는 프로그래머가 늘어남
    - 효용성을 느끼고 코드 리뷰를 통해 테스트하는 것을 전파
  - 테스트 커버리지도 증가
- 테스트 기반 다지기
  - 짜기 쉬워야 한다
  - 코드 최적화
  - 가끔 깨지는 테스트 원인 분석

## 2. 서버 테스트 작성하기

- 유닛 테스트와 통합 테스트는 몇 대 몇
  - 일반적인 경우
    - ![](/test.PNG)
  - 달빛조각사 팀의 경우
    - ![](/test2.PNG)
- 통합 테스트
  - 테스트 코드의 효용성
    - 서버 컨텐츠 자체를 테스트
    - 버그 재연에도 유용
  - 디자인 변경에 유연
    - 내부 구현 변경이 테스트에 영향을 주는 경향이 없다
  - 스토리를 작성하라
    - 클라이언트처럼 패킷을 주고 받는 스토리
    - 내부 상태 확인 X
    - 동작을 확인
- 유닛 테스트
  - 다양한 케이스에 대한 테스트가 필요할 때
    - 통합 테스트의 복잡한 준비 과정 X
  - 테스트 대상
    - 알고리즘
    - 기반 유틸 함수
  - 함수의 동작도 확인할 수 있어서 좋다
- 정리
  - 통합 테스트 비중이 높다
    - 통합 테스트: 서버 동작, 게임 컨텐츠
    - 유닛 테스트: 알고리즘, 공용 유틸 함수

## 3. 더 짜기 쉽고 더 튼튼하게

- 셋업을 손쉽게
  - 테스트 코드도 가독성이 좋아야 한다
  - 그래야 작성에 집중할 수 있다
- 게임 테이블 데이터
  - 초기에는 게임 테이블 데이터를 그대로 사용
    - 매번 테스트할 조건에 맞는 데이터찾기
    - 찾는 게 귀찮아서 특정 데이터가 반복적으로 사용됨
    - 기획자가 데이터를 변경해서 테스트가 실패하기도 함
- 패킷 순서
  - 패킷의 지연에 따라 테스트가 깨지기도 한다
  - 조합할 수 있는 패킷 설정
  - 테스트 헬퍼 함수 디자인에 도움
- sleep이 필요할 땐
  - 응답 패킷이 없거나
  - DB쓰기처럼 지연이 필요한 경우
  - 하드 코딩은 문제가 있다

## 4. 병렬 테스트로 더 빠르게

- 순차 실행은 답이 없다
  - 점점 오래 걸리는 테스트 시간
    - 이 소요 시간을 줄이기 위해 병렬 테스트를 시행하기로 결정
    - 테스트를 동시에 돌리자!
- 게임 테이블 데이터 수정이 문제
  - 하지만 기존 테이블 데이터를 수정하는 것이 문제였다
  - 수정하지 말고 추가
- 브로드캐스팅 패킷 정밀 검사
  - 현재 테스트 중인 캐릭터가 대상인지 검사
- 일부는 순차 테스트로 유지
- 결과
