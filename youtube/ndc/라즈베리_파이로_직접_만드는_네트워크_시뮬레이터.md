# 라즈베리 파이로 직접 만드는 네트워크 시뮬레이터

[영상 주소](https://www.youtube.com/watch?v=jy7jYeIlu9w)

> 1. 네트워크 시뮬레이터를 만드는 이유
> 2. 리눅스 네트워킹을 활용한 기본적 환경 제어
> 3. eBPF를 활용한 도메인 별 환경 제어
> 4. 편리한 유저 인터페이스 만들기
> 5. 재배포 이미지 만들기

## 1. 네트워크 시뮬레이터를 만드는 이유

- 네트워크 이슈는 개발 후 배포시에 항상 떠오르는 문제다
- 아래와 같은 이슈들이 상시적으로 존재하기 때문이다
  - 느리고 불안정한 네트워크
    - 패킷 로스 비율이 높거나, 전반적인 회선 속도가 느린 경우
  - 갑작스러운 네트워크 단절
    - 지하철을 타는 도중 wi-fi에서 lte로 바뀌는 등의 경우
  - 비대칭적인 전송속도
    - 다운로드는 빠른데 업로드는 느리다든지,
    - CDN은 빠른데 API 서버 통신은 느린 경우
- 기존 도구들의 단점
  - 설정하는 과정이 번거로움
  - 기능이 제한되어 다양한 시나리오를 재현하기 어려움
  - 비 소프트웨어 직군 분들의 사용이 어려움
- 직접 만드는 것의 장점
  - 원하는 기능을 전부 직접 구현할 수 있음
  - 클라이언트 수정 없이 연결만 하면 쉽게 사용할 수 있음
  - 전문 지식이 필요하지 않기에 개발자가 아니어도 사용에 부담이 없음
- 왜 라즈베리 파이인가
  - 하드웨어를 구하기 쉬움
  - 외장 디스플레이나 버튼 등 풍부한 확장 컴포넌트들
  - **리눅스가 돌아간다**

## 2. 리눅스 네트워킹을 활용한 기본적 환경 제어

1. 트래픽의 속도 조절과 불안정한 네트워크 상황을 재현
   - ![](./%EB%9D%BC%EC%A6%88%EB%B2%A0%EB%A6%AC%ED%8C%8C%EC%9D%B4%20%ED%98%BC%EB%9E%80.PNG)
   - qdisk에서 일어날 것이다
   - iproute2 [리눅스 기본 내장!]
     - 리눅스의 커널 네트워킹 스택과 통신할 수 있도록 해주는 유저 공간 유틸리티 모음집
     - 여러가지 가능하지만 `트래픽 컨트롤`을 이용할 예정
       - **대역폭 제한**
       - **불안정한 네트워크 환경 재현**
       - 트래픽 우선순위 매기기
       - 트래픽 분류
     - qdisk 종류는 아주 많지만 HTB와 netem을 중점으로 이용할 것이다.
       - HTB - 패킷 처리를 위한 표를 발급하는 개념
         - 표가 채워지는 속도로 패킷이 나가는 속도를 조절할 수 있다
       - netem - 각종 네트워크 상황을 에뮬레이션 해주는 qdisk
         - delay, packet loss corruption, reorder
   - ifb (인풋의 네트워크 상태를 조절하도록 함)
     - 통신이 들어오는 것을 ifb에 한번 통과한다
     - 즉, ifb의 나가는 통신을 조절하는 것은 패킷이 들어오는 것을 제어하는 것과 같은 상황이다
2. 무선 AP를 만들어주고 IP 동적 할당을 통해 기기를 연결할 수 있도록 하기
   - 네트워크 흐름도에서 wlan위치를 생각해야한다
   - 엑세스 포인트가 필요하다.
     - 라즈베리 파이가 하나의 wifi가 된다고 생각하면 된다.
   - hostapd로 무선 액세스 포인트를 만들어주고 (리눅스에서 쓰기 아주 편안)
   - dhcp 서버를 돌려서 ip 동적 할당을 해준다 (라즈베리파이에서 사용하기 편안함)
3. 연결된 기기 모두 인터넷을 자유롭게 사용할 수 있도록 하기
   - 바로 발급받은 IP로는 인터넷이 안된다.
   - 여러 기기로 동시에 하는 것도 힘들수가 있다
   - iptables의 Masquerading rule을 사용
     - 여러 ip들의 연결을 구분해서 각각에 대해 source NAT를 수행해준다
     - ![](/masquerade.PNG)

## 3. eBPF를 활용한 도메인 별 환경 제어

- 모든 트래픽이 아닌 '특정 기준을 만족하는 트래픽'만 제어해보고 싶음(cdn 다운로드만 제어해보거나)
- 혹은 기준에 따라 다른 종류의 제어를 원함
- 패킷을 도메인 별로 '분류'하는 작업이 필요하다!
- TC의 filter를 이용해서 ip별로 제어가 가능하다
- 도메인 이름은 네임서버를 통해 ip로 리졸브 후 통신
  - 하지만 이 ip는 바로 이용이 힘들다
    - 시간과 장소에 따라 리졸브된 ip가 다를 수 있다
    - 리졸브된 ip가 여러 개일 수 있다
    - CANME 레코드로 다른 이름을 가질 수 있다
  - 도메인이 가르키는 모든 ip에 대해 filter을 이용해야만 한다
    - 그리고 이것은 조금 힘들어질 수 있다
    - 그리하여 우리는 **eBPF**를 이용한다
      - 안전한 바이트코드 프로그램을 커널에서 실행할 수 있도록 해줌
    - ![](/ebpf.PNG)

## 4. 편리한 유저 인터페이스 만들기

- 모든 사람이 사용할 수 있도록
  - 물리버튼
  - 디스플레이

## 5. 재배포 이미지

- 모든 것이 미리 세팅된 이미지를 준비하기
  - 시뮬레이터 프로그램
  - iptables 설정
  - hostapd
  - dhcp 서버
- systemd service를 이용해서 전원을 꽂음과 동시에 모든 컴포넌트들이 실행될 수 있도록 한다
  - > systemctl enable network-simulator.service
