# 데이터베이스 more

> 1. 용어 정리
> 2. Key
> 3. SQL Injection
> 4. Join
> 5. SQL vs NoSQL
> 6. 이상
> 7. 인덱스

# 1. 용어정리

- 테이블
  - 행과 열로 이루어진 데이터의 집합을 테이블이라고 한다.
  - 흔히 생각하느 엑셀을 떠올리면 편하다.
  - 관계형 데이터베이스에서는 특별한 제약을 추가해 relation이라고 부르기도 한다
  - 아래 조건을 충족하는 테이블만이 릴레이션이 될 수 있기 때문에 모든 릴레이션은 테이블이지만 모든 테이블이 릴레이션이진 않아
    - 모든 값은 유일한 값을 가진다.
    - 하나의 릴레이션에서 중복되는 행이 존재하면 아된다
- 행
  - 테이블을 구성하는 데이터들 중 가로로 묶은 데이터셋
  - 일바적으로 행은 한 객체에 대한 정보를 가지고 있다.
  - 이또한 관계형 데이터베이스에서는 튜플 또는 레코드라는 이름으로 불린다
- 열
  - 테이블을 구성하는 데이터들 중 세로로 묶은 데이터셋을 의미한다.
  - 일반적으로 열으 그 테이블의 속성을 의미하며 열을 구성하는 값들은 같은 도메인으로 되어있다.
  - 이또한 관계형 데이터베이스에서는 속성이라는 이름으로 불린다.
- 도메인
  - 데이터베이스에서 필드에 채워질 수 있는 값의 집합이다.
  - 예를 들어, 도메인이 1에서 10사이의 정수인 속성의 필드에 11이나 -1처럼 도메인을 벗어나는 값 또는 고양이처럼 아예 자료형이 다른 값이 들어갈 수 없다
- 스키마
  - 데이터베이스의 구조를 전반적으로 기술한 것
  - 구체적으로 데이터베이스를 구성하는 데이터 레코드의 크기, 키의 정의, 레코드 간의 관계 등을 정의한 것을 말한다
  - 사용자의 관점에 따라 외부 스키마, 개념 스키마, 내부 스키마로 구분한다.
  - DBMS는 외부 스키마에 명세되 사용자의 요구를 개념 스키마 형태로 벼환하고, 이를 다시 내부 스키마 형태로 벼화한다.
  - 외부 스키마
    - 사용자의 입장에서 정의한 데이터베이스의 논리적 구조
    - 데이터들을 어떤 형식, 구조, 화면을 통해 사용자에게 보여줄 것인가에 대한 명세를 말하며 하나의 데이터베이스에는 여러 개의 외부 스키마가 있을 수 있다.
    - 일반 사용자에게는 질의어를 이용해 DB를 쉽게 사용할 수 있도록 하고 응용 프로그래머는 언어를 사용해서 DB에 접근하도록 한다.
  - 개념 스키마
    - 조직체 전체를 관장하는 입장에서 DB를 정의한 스키마
    - DB에 대한 모든 논리적 구조를 기술하기 때문에 데이터베이스에 하나만 존재하며, 통상 스키마라고 하면 개념 스키마이다.
  - 내부 스키마
    - 데이터 베이스가 어떻게 저장 장치에 저장될 지에 대한 명세
    - 물리적인 저장 장치와 데이터베이스 간의 관계를 정의하므로 시스템 프로그래머나 시스템 설계자가 보는 관점의 스키마이다.

# 2. Key

1. Candidate Key (후보키)
   - 릴레이션을 구성하는 속성들 중에서 Tuple을 유일하게 식별할 수 있는 속성들의 부분ㄴ집합
   - 모든 릴레이션은 반드시 하나 이상의 후보 키를 가져야 한다
   - 릴레이션에 있는 모드 튜플에 대해서 유일성과 최소성을 만족
   - 유일성
     - Key로 하나의 Tuple을 유일하게 식별할 수 있음
   - 최소성
     - 꼭 필요한 속성으로만 구성
2. Primary Key (기본키)
   - 후보 키 중 선택한 Main Key
   - 한 릴레이션에서 특정 튜플을 유일하게 구분할 수 있는 속성
   - Null값을 가질 수가 없다
   - 기본 키로 정의된 속성에는 동일한 값이 중복되어 저장될 수 없다. (개체 무결성의 두번째 조건)
     - 유일성
       - 기본키를 구성하는 컬럼은 테이블에서 레코드를 식별할 수 있도록 유일해야한다.
     - 최소성
       - 유일성을 만족하는 한도 내에서 최소한의 컬럼으로 구성되어야 한다
     - 개체 무결성
       - 기본키가 가지고 있는 값의 유일성을 보장받아야 한다.
3. Alternate Key (대체키)
   - 후보키가 둘 이상일 때, 기본 키를 제외한 나머지 후보키들을 말한다.
   - 보조키라고도 한다.
4. Super Key (슈퍼키)
   - 한 릴레이션 내에 있는 속성들의 집합으로 구성된 키로서 릴레이션을 구성하는 모든 튜플 중 슈퍼키로 구성된 속성의 집합과 동일한 값을 나타내지 않는다
   - 일레이션을 구성하는 모든 튜플에 대해서 유일성은 만족하지만, 최소성은 만족하지 못한다.
   - ex) 학번+주민번호
5. Foreign Key (외래키)
   - 관계를 맺고 이쓴 릴레이션에서 릴레이션 하ㅏ가 참조하고 있느 다른 릴레이션의 기본키와 같은 릴레이션의 속성을 외래키

# 3. SQL Injection

## 공격방법

1. 인증 우회

   아이디가 abc 비밀번호가 1234일때 다음과 같은 쿼리를 이용한다고 해보자

   ```sql
   SELECT * FROM USER WHERE ID = "abc" AND PASSWORD = "1234";
   ```

   SQL Injection으로 공격할 때, input 창에 비밀번호를 입력함과 동시에 다른 쿼리문을 함께 입력하는 것이다.

   ```sql
   1234; DELETE * FROM USER WHERE ID = "1";
   ```

   보안이 완벽하지 않은 경우 이와같은 상황에서 True가 발생하고 뒤에 작성된 sql문이 실행이 된다. 아니면 or '1' = '1' 이런식으로 True를 강제로 발생시키는 것도 가능하다

2. 데이터 노출

   시스템에서 발생하는 에러 메시지를 이용해 공격하는 방법이다.

   보통 에러는 개발자가 버그를 수정하는 면에서 도움을 받을 수 있는 존재이다. 해커들은 이를 역이용해 악의적인 구문을 삽입하여 에러를 유발시킨다.

   예를 들면, 해커는 GET방식으로 동작하는 URL 쿼리 스트링을 추가하여 에러를 발생시킨다

   이에 해당하는 오류가 발생하면 이를 통해 해당 웹앱의 데이터베이스 구조를 유추할 수 있고 해킹에 활용한다

## 방어 방법

1. input 값을 받을 때, 특수 문자 여부 검사
2. SQL 서버 오류 발생 시, 해당하느 에러 메시지 감추기
3. prepare statement 사용하기

# 4. Join

## 조인이란

- 두 개 이상의 테이블이나 데이터베이스를 연결하여 데이터를 검색하느 방법을 말한다.
- 테이블을 연결하려면, 적어도 하나의 칼럼을 서로 공유하고 있어야 하므로 이를 이용하여 데이터 검색에 활용하다

## join의 종류들

1. INNER JOIN
   - 쉽게 말해 교집합
   - 기준 테이블과 Join한 테이블의 중복된 값을 보여준다.
   - 결과 값은 A의 테이블과 B테이블이 모두 가지고 있는 데이터마 검색된다.
2. LEFT OUTER JOIN
   - 기준 테이블의 값 + 테이블과 기준 테이블의 중복된 값
   - 결과값은 A테이블의 모든 값과 A 테이블과 B테이블의 중복되는 값이 검색된다.
3. RIGHT OUTER JOIN
   - LEFT 와 반대
   - 결과값은 B테이블의 모드 값과 A테이블과 B테이블에서 중복되는 값이 검색된다.
4. FULL OUTER JOIN
   - 합집합
   - A 테이블이 가지고 있는 데이터, B 테이블이 가지고 있는 데이터 모두 검색
5. CROSS JOIN
   - 모든 경웅의 수를 전부 표현해주는 방식
   - 기준테이블(A)의 데이터 한 ROW와 JOIN하는 테이블 전체(B)와 JOIN하는 방식
   - 결과 값은 A의 개수 * B의 개수
6. SELF JOIN
   - 자기 자신과 자기 자신을 조인
   - 자신이 가지고 있는 칼럼을 다양하게 변형시켜 활용할 경우에 사용

# 5. SQL vs NoSQL

## SQL(관계형 DB)

- SQL은 RDBMS에서 데이터 저장,수정,삭제,검색이 가능
- 정해진 데이터 스키마에 따라 테이블에 저장된다
- 데이터는 관계를 통해 여러 테이블에 분산된다
- 장점
  - 명확하게 정의된 스키마, 데이터 무결성 보장
  - 관곈는 중복없이 한번만 저장
- 단점
  - 덜 유연하다. 데이터 스키마를 사전에 계획하고 알려야 한다
  - 관계를 맺고 있어서 조인문이 많은 복잡한 쿼리가 만들어질 수 있음
  - 대체로 수직적 확장만 가능
- 더 좋을 때
  - 관계를 맺고 데이터가 자주 변경된는 애플리케이션의 경우
  - 변경될 여지가 없고, 명확한 스키마가 사용자와 데이터에게 중요한 경우

## NoSQL(비관계형 DB)

- 스키마도 없고 관계도 없다
- NoSQL에서는 레코드를 문서라고 부른다
- 장점
  - 스키마가 없어서 유연. 언제든지 저장된 데이터를 조정하고 새 필드 추가 가능
  - 데이터는 애플리케이션이 필요로 하는 형식으로 저장. 데이터를 읽어오는 속도가 빨라짐
  - 수직 및 수평 확장이 가능해서 애플리케이션이 발생시키는 모든 읽기/쓰기 요청 처리가 가능
- 단점
  - 데이터 구조 결정을 미루게 될 수 있다.
  - 데이터 중복을 계속 업데이트 해야한다.
  - 데이터가 여러 컬렉션에 중복되어 있기 때문에 수정시 모든 컬렉션에서 수행해야한다
- 더 좋을 때
  - 정확한 데이터 구조를 알 수 없거나 변경/확장이 될 수 있는 경우
  - 읽기를 자주 하지만, 데이터 변경은 자주 없는 경우
  - 데이터베이스를 수평적으로 확장해야하는 경우

# 6. 이상

잘못된 테이블 설계로 이상현상이 발생할 수 있다. 정규화를 잘하도록 하자

1. 삽입 이상

   기본기가 {Student Id, Course Id}인 경우

   Course를 수강하지 않은 학생은 Course Id가 없는 현상 발생. 결국, Course Id를 Null로 할 수 밖에 없는데 기본키는 Null이면 안된다. 굳이 삽입하기 위해 '미수강'이라는 값을 만들어야함

   불필요한 데이터를 추가해야 삽입할 수 있는 상황

2. 갱신 이상

   일부만 변경하여 데이터가 불일치하는 모순의 무제

3. 삭제 이상

   튜플 삭제로 인해 꼭 필요한 데이터까지 함께 삭제되는 무제

# 7. 인덱스

## 의미

- 검색 속도를 높이기 위해 사용하는 기술
- INDEX는 색인이다.
- 테이블 컬럼을 색인화 => 검색시 색인화 되어있는 INDEX 파일을 검색
- INDEX구조는 Tree, Balance Search Tree를 사용

## 원리

- FRM: 테이블 구조가 저장되어 있는 파일
- MYD: 실제 데이터가 있는 파일
- MYI: INDEX 정보가 들어있는 파일
- SELECT쿼리로 INDEX를 사용하는 쿼리를 사용시 해당 Table을 검색하느 것이 아니라 MYI파일의 내용을 검색. 

## 장단점

- 장점
  - 키 값을 기초로 하여 테이블에서 검색과 정렬 속도를 향상
  - 인덱스를 사용하면 테이블 행의 고유성 강화
  - 기본키는 자동 인덱스
  - 필드 중에는 데이터 형식 때문에 인덱스 될 수 없는 필드도 있다
  - 여러 필드로 이루어진 인덱스를 사용하면 첫 필드 값이 같은 레코드도 구분할 수 있다.
- 단점
  - mdb파일 크기가 늘어난다
  - 한 페이지를 동시에 수정할 수 있는 병행성 감소
  - 레코드를 추가 또는 삭제할 때 성능 감소
  - 인덱스가 데이터베이스 공가을 차지재 추가적이 공간이 필요해진다
  - 인덱스를 생성하느데 시간이 많이 소요
  - 데이터 변경이 자주 일어나면 인덱스를 그만큼 수정해야함