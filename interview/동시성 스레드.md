# 동시성

스레드 관련 문제는 AJAX 스타일로 작업을 처리하는 자바스크립트 프로그램처럼 명시적으로 스레드를 지원하지 않는 환경에서도 중요하다. 웹 서버의 응답이 비동기적으로 처리되고, 그 응답을 처리하기 위해 실행되는 자바스크립트에서 애플리케이션의 다른 부분에서 동시에 사용하는 데이터를 건드려야 할 수 있기 때문이다. 따라서 좋은 프로그래머가 되고 싶다면 어느 정도 시간을 투자해서 멀티스레드 프로그램을 올바르게 만드는 방법을 배워야한다.

## 스레드 기본 개념

멀티스레드 프로그래밍은 기본적으로 단일스레드 프로그래밍보단 당연히 힘들다. 스레드를 만들고 없애는 것도 큰일인데 멀티 스레드는 여러 스레드에서 공유하는 자원에 대한 접근도 잘 조율해야한다. 이 공유 자원에 대한 접근을 제대로 제어하지 못하면 단일 스레드 애플리케이션에서는 볼 수 없는 여러 유형의 버그가 발생한다.

### 스레드

스레드는 애플리케이션의 실행에 있어서 가장 기본적인 단위이다. 최소 하나의 스레드가 애플리케이션 구동중에 구성되어있다. 스레드마다 별도의 스택이 있으며 각 스레드는 같은 애플리케이션에 있어도 각자 알아서 돌아간다.

스레드는 여러 방식으로 구현할 수 있으며 대부분 시스템에서 스레드는 운영체제에서 생성하고 관리한다.

### 시스템 스레드와 사용자 스레드

시스템 스레드는 시스템에서 새엇ㅇ하고 관리한다. 애플리케이션의 첫번째 스레드(= 메인 스레드)는 시스템 스레디이며, 보통 이것이 끝날때 애플리케이션이 종료된다. 사용사 스레드는 메인 스레드에서 할 수 없는, 혹은 하면 안되는 작업을 해야 할 때 애플리케이션에서 명시적으로 생성하는 스레드이다.

사용자 인터페이스를 화면에 표시하는 애플리케이션에서는 특히 스레드 사용에 주의해야한다. 그런 애플리케이션의 메인스레드는 이벤트스레드라고도 부른다. 이벤트가 일어날 때까지 기다렸다가 그 이벤트를 애플리케이션에서 처리할 수 있도록 전달하는 역할을 하기 때문이다. 

### 모니터와 세마포어

스레드와 공유 자원 사이의 상호작용을 제어할 때는 **스레드 동기화** 메커니즘을 써야한다. 스레드 동기화는 **모니터**와 **세마포어**로 구성된다. 어ㅓ느 쪽을 쓰는지는 시스템과 언어에서 어느 쪽을 지원하는지에 따라 달라진다.

- 모니터

  상호 배제 자물쇠로 보호되는 루틴의 집합을 모니터라고 부른다. 스레드는 자물쇠를 획득하기 전까지는 모니터에 속하는 루틴을 하나도 실행할 수 없다. 즉, 한 모니터 내에서는 한 스레드씩 실행된다. 다른 스레드는 전부 지금 실행중인 스레드에서 그 자물쇠를 놓아줄 때까지 기다려야만 한다. 모니터에 속하는 어떤 스레드가 다른 어떤 이벤트가 발생할 때까지 기다리기 위해 스스로 멈추면 다른 스레드가 모니터로 진입할 수 있다.

- 세마포어

  세마포어는 더 간단하다. 공유 자원을 보호하기 위한 자물쇠만 있을 뿐이다. 스레드에서 공유 자원을 사용하려면 자물쇠를 획득해야 한다. 자물쇠를 쥐고 있는 스레드에서 놓아주기 전까지는 그 자원을 획득하려는 다른 스레드는 막히게 되고, 자물쇠를 놓아주는 순간 기다리고 있던 스레드가 그 자물쇠를 획득한다. 이렇게 가장 기본적인 방식의 세마포어를 **상호 배제 (줄여서 뮤텍스) 세마포어**라고 한다.. 이 외에도 **카운팅 세마포어**(n을 정해두고 자원을 동시에 n개의 스레드가 접근가능), **이벤트 세마포어**(어떤 이벤트가 발생하면 대기 중인 스레드 중 하나 or 모든 스레드에 알림) 등이 있다.

- 둘의 비교

  비슷한 목적을 달성할 수 있다. 하지만 자물쇠의 획득과 해제를 모두 처리해 주는 모니터 쪽이 더 간단하게 쓰기에 좋다. 세마포어를 쓸 때는 각 스레드에서 획득한 자물쇠를 해제하는 작업을 일일히 챙겨줘야 한다. 즉, 실수하면 스레드가 멎어버릴 수 있다.

### 데드락

두 스레드가 서로 상대방이 쥐고 있는 자물쇠가 풀리기만을 기다리면서 서로 가로막고 있는 상황이 벌어질 수 있다. 이걸 데드락이라고 부른다. 데드락이 일어나슷 전형적인 시나리오는 아래와 같다.

두 프로세스가 다음 단계로 넘어가기 위해서 두 개의 락(A,B)을 획득해야 하는데 서로 반대되는 선수러 락을 획득하려고 하는 경우를 들 수 있다. 1번 프로세스에서 A를 획득했는데 2번 프로세스에서 1번 프로세스보다 먼저 B를 획득하면 1번 프로세스는 2번 프로세스가 갖고 있는 B를 획득할 때까지 멈춰 있어야한다. 그리고 2번 프로세스는 1번 프로세스가 A를 줄때까지 멈춰있는다.

## 스레딩 예제

아래 C#코드를 참고해보자

```c#
public class Account {
    int userNumber;
    String userLastName;
    String userFirstName;
    double userBalance;
    public boolean deposit( double amount ){
        double newBalance;
        if ( amount < 0.0 ){
            return false;
        } else {
            newBalance = userBalance + amount;
            userBalance = newBalance;
            return true;
        }
    }
    public boolean withdraw( double amount ){
        double newBalance;
        if ( amount < userBalance ){
            return false;
        } else {
            newBalance = userBalance - amount;
            userBalance = newBalance;
            return true;
        }
    }
}
```

위와 같은 atm의 코드가 있다고 하자. 뭐 일반적인 경우에는 그냥 괜찮을 것 같다고 생각되지만 부부 A,B가 있다고 해보자. 500달러가 들어있는 같은 계좌에서 둘이 동시에 100달러를 뺀다고 해보자. A가 빼고 있는데 B가 빼고있다. A의 작업이 완료되지 않아서 아직 계좌에는 500달러로 기록되어있을 것이다. 그런데 이런 일이 일어나면 둘은 각각 100달러씩 총 200달러를 받겠지만 은행입장에서는 100달러만 나간 것으로 기록되어있을 것이다! 동시성을 이용해 해결할 수가 있는데 자바는 다음과 같이 빠르게 해결할 수가 있다.